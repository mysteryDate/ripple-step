<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script> -->
  <script src="./three.js"></script>
  <script src="./node_modules/tone/build/Tone.js"></script>
  <!-- <script src="./bundle.js"></script> -->
  <style media="screen">
    body {
      margin: 0px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <!-- <script src="bundle.js"></script> -->
<script type="text/javascript">

// function Key(note, options) {
//
//   return {
//     mesh: mesh,
//   }
// }

var container = document.getElementById("container");
var renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
container.appendChild(renderer.domElement);
var scene = new THREE.Scene();
var camera = new THREE.OrthographicCamera(-window.innerWidth/2, window.innerWidth/2, window.innerHeight/2, -window.innerHeight/2, 0.1, 100);
camera.position.set(window.innerWidth/2, window.innerHeight/2, 50);

var BASE_COLOR = new THREE.Color(0x54576b);
var ACTIVE_COLOR = new THREE.Color(0x4655b7);
var NUM_STEPS = 16;
var KEY_SIZE = 50;
var SPACING = KEY_SIZE/10;
var keyGeom = new THREE.PlaneBufferGeometry(KEY_SIZE, KEY_SIZE);
var keyGroup = new THREE.Group();
var i;
var j;
for (i = 0; i < NUM_STEPS; i++) {
  for (j = 0; j < NUM_STEPS; j++) {
    var mat = new THREE.MeshBasicMaterial({color: BASE_COLOR});
    var mesh = new THREE.Mesh(keyGeom, mat);
    keyGroup.add(mesh);
    mesh.position.set(i, j, 0);
    mesh.position.multiplyScalar(KEY_SIZE + SPACING);
    mesh.position.add(new THREE.Vector3(KEY_SIZE/2, KEY_SIZE/2, 0)); // So the origin is the lower left
    mesh.note = j;
  }
}
scene.add(keyGroup);

// SYNTH
var NOTES = ["C", "D", "E", "G", "A"];
// create a synth and connect it to the master output (your speakers)
var synth = new Tone.Synth().toMaster();

// Click handler
var raycaster = new THREE.Raycaster();
function onDocumentClick(event) {
  var mouse = new THREE.Vector2();
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  var clickedKey = raycaster.intersectObjects(keyGroup.children)[0];
  if (clickedKey !== undefined) {
    clickedKey.object.material.color = ACTIVE_COLOR;
    var note = NOTES[clickedKey.object.note % NOTES.length];
    var ocatve = Math.floor(clickedKey.object.note / NOTES.length) + 3;
    // Duration of an 8th note
    synth.triggerAttackRelease(note + ocatve, "8n");
  }
}
document.addEventListener("click", onDocumentClick, false);


function update() {
  renderer.render(scene, camera);
  requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
