<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style media="screen">
    body {
      margin: 0px;
      background-color: black;
      overflow: hidden;
    }
  </style>
  <!-- <script src="build/bundle.js"></script> -->
  <script src="../node_modules/three/build/three.js"></script>
  <script src="../build/testbed.bundle.js"></script>
</head>
<body>
  <div id="container"></div>
  <script>
    /* global THREE, RS */
    var container = document.getElementById("container");
    var renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);
    var scene = new THREE.Scene();
    var camera = new THREE.OrthographicCamera(-window.innerWidth/2, window.innerWidth/2, window.innerHeight/2, -window.innerHeight/2, 0.1, 100);
    camera.position.set(0, 0, 50);

    function Knob() {
      THREE.Group.call(this);
      var SENSITIVITY = 1; // How many degrees the knob turns per pixel

      var isActive = false;
      var touchStartRotation = 0;
      var touchStartPos = new THREE.Vector2();

      RS.Textures.createTexture("sword_icon.png", "../textures/sword_icon.png");
      var tex = RS.Textures.get("sword_icon.png");
      var bodyGeom = new THREE.CircleBufferGeometry(150, 100);
      var bodyMat = new THREE.MeshBasicMaterial({color: "pink", map: tex});
      this.body = new THREE.Mesh(bodyGeom, bodyMat);
      this.add(this.body);

      this.touchStart = function(raycaster, mouse) {
        var touch = raycaster.intersectObjects(this.children)[0];
        if (touch) {
          isActive = true;
          touchStartPos = mouse;
          touchStartRotation = this.rotation.z;
        }
      };

      this.touchEnd = function() {
        isActive = false;
      };

      this.touch = function(mouse) {
        if (isActive) {
          var touchDiff = mouse.y - touchStartPos.y;
          this.rotation.z = touchStartRotation + SENSITIVITY * touchDiff;
        }
      };
    }
    Knob.prototype = Object.create(THREE.Object3D.prototype);

    var knob = new Knob();
    scene.add(knob);

    function update() {
      renderer.render(scene, camera);
      requestAnimationFrame(update);
    }

    var raycaster = new THREE.Raycaster();
    function onDocumentMouseDown(event) {
      var mouse = new THREE.Vector2();
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      knob.touchStart(raycaster, mouse);
    }
    function onDocumentMouseMove(event) {
      var mouse = new THREE.Vector2();
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      // raycaster.setFromCamera(mouse, camera);
      knob.touch(mouse);
    }
    function onDocumentMouseUp(event) {
      knob.touchEnd();
    }

    document.addEventListener("mousemove", onDocumentMouseMove, false);
    document.addEventListener("mousedown", onDocumentMouseDown, false);
    document.addEventListener("mouseup", onDocumentMouseUp, false);

    renderer.render(scene, camera);
    window.setTimeout(function() {
      update();
    }, 100);
  </script>
</body>
</html>
